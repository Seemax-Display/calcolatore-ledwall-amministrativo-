<!-- Calcolatore Ledwall Ufficiale Seemax ‚Äì Admin 1.3.2 ‚Äì Minimal + Dark switch -->
<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>‚ö†Ô∏èCalcolatore Ledwall Ufficiale Seemax ‚Äì Admin 1.3.2‚ö†Ô∏è</title>
<!-- Font minimal/pro -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    /* RESET */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Minimal (default) */
      --bg-page: radial-gradient(circle at top, #e5edff 0, #f3f4f6 55%);
      --bg-surface: #ffffff;
      --bg-subtle: #f9fafb;
      --border-subtle: #e5e7eb;
      --border-strong: #d1d5db;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --accent-strong: #1d4ed8;
      --danger: #ef4444;
      --success: #16a34a;
      --warning: #f59e0b;

      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.12);
      --shadow-subtle: 0 1px 3px rgba(15, 23, 42, 0.08);
    }

    /* Override variabili per tema dark */
    body.theme-dark {
      --bg-page: radial-gradient(circle at top, #020617 0, #020617 60%);
      --bg-surface: #020617;
      --bg-subtle: #020617;
      --border-subtle: #1e293b;
      --border-strong: #374151;
      --text-primary: #e5e7eb;
      --text-secondary: #cbd5f5;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --accent-strong: #38bdf8;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;

      --shadow-soft: 0 22px 60px rgba(0, 0, 0, 0.9);
      --shadow-subtle: 0 1px 4px rgba(15, 23, 42, 0.85);
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
      position: relative;
      overflow-x: hidden;
      transition: background 0.25s ease, color 0.25s ease;
    }

    /* PARTICLE BACKGROUND ‚Äì molto discreto dietro */
    #particle-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.18;
      mix-blend-mode: multiply;
      transition: opacity 0.25s ease, mix-blend-mode 0.25s ease;
    }

    body.theme-dark #particle-bg {
      opacity: 0.5;
      mix-blend-mode: normal;
    }

    /* SHELL APPLICAZIONE */
    .app-frame {
      width: 100%;
      max-width: 1200px;
      position: relative;
      z-index: 1;
    }

    .container {
      background: var(--bg-surface);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 20px 22px 22px;
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    body.theme-dark .container {
      border-color: #1f2937;
    }

    /* HEADER */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .brand-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #93c5fd, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      transition: box-shadow 0.25s ease, background 0.25s ease;
    }

    body.theme-dark .brand-logo {
      background: radial-gradient(circle at 30% 20%, #1d4ed8, #020617);
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.8);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .brand-text span:first-child {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .brand-text span:last-child {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .heading-area {
      flex: 1;
      text-align: center;
    }

    .heading-area h1 {
      font-size: 18px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--text-primary);
    }

    .heading-area p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .badge-area {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 160px;
    }

    .pill {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      background: var(--bg-subtle);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--success);
    }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--bg-subtle);
      color: var(--text-muted);
    }

    /* THEME TOGGLE */
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-subtle);
      gap: 2px;
    }

    .theme-toggle-btn {
      border: none;
      background: transparent;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.18s ease, color 0.18s ease, transform 0.1s ease;
    }

    .theme-toggle-btn--active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
      transform: translateY(-0.5px);
    }

    .theme-toggle-btn:active {
      transform: translateY(0.5px);
    }

    /* LAYOUT PRINCIPALE */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
      gap: 20px;
      align-items: flex-start;
    }

    .panel {
      background: var(--bg-subtle);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 14px 16px 16px;
      box-shadow: var(--shadow-subtle);
      transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }

    body.theme-dark .panel {
      background: rgba(15, 23, 42, 0.96);
    }

    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 12px;
    }

    .panel-header h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
    }

    .panel-header p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .panel-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel-results {
      min-height: 280px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* CAMPI / FORM */
    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 4px;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      background-color: #ffffff;
      color: var(--text-primary);
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, color 0.15s ease;
      appearance: none;
    }

    input[type="number"]::placeholder {
      color: var(--text-muted);
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      background-color: #ffffff;
    }

    body.theme-dark input[type="number"],
    body.theme-dark select {
      background-color: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    body.theme-dark input[type="number"]::placeholder {
      color: #6b7280;
    }

    /* BIFACCIALE ‚Äì switch minimale */
    .field-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px dashed var(--border-subtle);
      transition: background 0.25s ease, border-color 0.25s ease;
    }

    body.theme-dark .field-toggle {
      background: #020617;
      border-color: #1f2937;
    }

    #bifacciale {
      width: 40px;
      height: 22px;
      appearance: none;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      cursor: pointer;
      transition: background 0.18s ease;
      flex-shrink: 0;
    }

    #bifacciale::before {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      top: 2px;
      left: 2px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.35);
      transition: transform 0.18s ease;
    }

    #bifacciale:checked {
      background: var(--accent-soft);
    }

    #bifacciale:checked::before {
      transform: translateX(18px);
    }

    .toggle-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .toggle-text label[for="bifacciale"] {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
    }

    .toggle-text span {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* SELETTORI INSTALLAZIONE / PROVINCIA */
    .select-wrapper {
      position: relative;
    }

    .select-wrapper::after {
      content: "‚ñæ";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .provincia-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .provincia-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      color: #ffffff;
      min-width: 90px;
      text-align: right;
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.12);
      transition: box-shadow 0.25s ease, border-color 0.25s ease;
    }

    body.theme-dark .provincia-pill {
      border-color: rgba(15, 23, 42, 0.7);
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.8);
    }

    /* ALERT */
    #alertContainer {
      font-size: 13px;
    }

    .alert {
      margin-top: 0;
      padding: 10px 11px;
      border-radius: 10px;
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
      line-height: 1.4;
    }

    .alert a {
      color: #b91c1c;
      font-weight: 500;
      text-decoration: underline;
    }

    .alert a:hover {
      text-decoration: none;
    }

    body.theme-dark .alert {
      background: #111827;
      color: #fecaca;
      border-color: #b91c1c;
    }

    body.theme-dark .alert a {
      color: #fecaca;
    }

    /* CARDS RISULTATI */
    .cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .cards::-webkit-scrollbar {
      width: 4px;
    }
    .cards::-webkit-scrollbar-track {
      background: transparent;
    }
    .cards::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    body.theme-dark .cards::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.9);
    }

    .card {
      position: relative;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 10px 11px 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
      transition:
        box-shadow 0.14s ease,
        transform 0.14s ease,
        border-color 0.14s ease,
        background 0.14s ease,
        color 0.14s ease;
    }

    .card.green {
      border-left: 3px solid var(--success);
    }

    .card.red {
      border-left: 3px solid var(--danger);
    }

    .card.yellow {
      border-left: 3px solid var(--warning);
    }

    .card.best {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2), 0 6px 16px rgba(37, 99, 235, 0.18);
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card-icon {
      font-size: 22px;
      margin-right: 6px;
    }

    .card-title-block {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #075985;
    }

    .card p {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .card .cabinet,
    .card .price,
    .card .priceClient {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card .margin,
    .card .marginClient,
    .card .marginInstall,
    .card .marginKm {
      font-size: 12px;
      font-weight: 500;
      color: var(--success);
    }

    .card .bifacciale-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--danger);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    body.theme-dark .card {
      background: linear-gradient(145deg, #0f172a, #020617);
      border-color: #1e293b;
      color: #e5e7eb;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
    }

    body.theme-dark .card:hover {
      background: #020617;
    }

    body.theme-dark .card p {
      color: #9ca3af;
    }

    body.theme-dark .card .cabinet,
    body.theme-dark .card .price,
    body.theme-dark .card .priceClient {
      color: #e5e7eb;
    }

    body.theme-dark .card .margin,
    body.theme-dark .card .marginClient,
    body.theme-dark .card .marginInstall,
    body.theme-dark .card .marginKm {
      color: #22c55e;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.16);
      background: #f9fafb;
    }

    /* Tooltip minimal */
    .tooltip {
      position: relative;
      border-bottom: 1px dotted var(--border-strong);
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 230px;
      background-color: #111827;
      color: #f9fafb;
      text-align: left;
      border-radius: 8px;
      padding: 8px 9px;
      position: absolute;
      z-index: 20;
      bottom: 130%;
      left: 0;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.18s ease, transform 0.18s ease;
      font-size: 11px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      box-shadow: 0 10px 20px rgba(17, 24, 39, 0.45);
    }

    body.theme-dark .tooltip .tooltiptext {
      background-color: #020617;
      border-color: #1f2937;
      color: #f9fafb;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }

    /* POPUP contenuto */
    .card-popup {
      position: absolute;
      inset: 6px 6px 6px 6px;
      background: #111827;
      color: #f9fafb;
      padding: 10px 10px 8px;
      border-radius: 10px;
      display: block;
      opacity: 0;
      transform: translateY(10px);
      z-index: 30;
      font-size: 12px;
      overflow-y: auto;
      border: 1px solid rgba(75, 85, 99, 0.7);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }

    .card.show-popup .card-popup {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    body.theme-dark .card-popup {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    /* BOTTONE RICHIESTA */
    .btn-request {
      margin-top: 4px;
      align-self: flex-start;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 500;
      background: #111827;
      color: #f9fafb;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn-request::after {
      content: "‚Üó";
      font-size: 11px;
    }

    .btn-request:hover {
      transform: translateY(-1px);
      background: #030712;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.45);
    }

    .btn-request:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.5);
    }

    body.theme-dark .btn-request {
      background: #0b1120;
      color: #e5e7eb;
    }

    body.theme-dark .btn-request:hover {
      background: #020617;
    }

    /* PANEL LAYOUT */
    .panel-layout {
      margin-top: 16px;
    }

    #layoutContainer {
      margin-top: 4px;
      font-size: 13px;
    }

    #layoutContainer h3 {
      margin-bottom: 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    #layoutContainer > div {
      margin: 0 auto 10px;
    }

    /* Celle layout: vengono create da JS */
    #layoutContainer > div > div {
      border-radius: 4px;
      background: #dbeafe;
      border: 1px solid #bfdbfe;
    }

    body.theme-dark #layoutContainer > div > div {
      background: #1f2937;
      border-color: #0f172a;
    }

    /* SPLASH MINIMAL */
    #splash {
      position: fixed;
      inset: 0;
      background: #111827;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #splash.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #splash-logo {
      font-size: 24px;
      text-transform: uppercase;
      letter-spacing: 0.4em;
      color: #f9fafb;
      font-weight: 600;
      margin-bottom: 16px;
    }

    #loading-bar {
      width: 220px;
      height: 6px;
      border-radius: 999px;
      background: #1f2937;
      overflow: hidden;
    }

    #loading-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #4f46e5);
      transition: width 0.3s ease;
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .heading-area {
        text-align: left;
      }
      .badge-area {
        align-items: flex-start;
      }
      .main-grid {
        grid-template-columns: 1fr;
      }
      .panel-results {
        order: 2;
      }
      .panel-layout {
        order: 3;
      }
    }
  
    /* UNIFICA CABINET (solo P3.91) */
    .btn-unifica{
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 800;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      position: relative;
      z-index: 50;
      letter-spacing: 0.04em;
      box-shadow: 0 8px 16px rgba(239, 68, 68, 0.18);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      white-space: nowrap;
    }

    .btn-annulla-unifica{
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 800;
      background: #111827;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      letter-spacing: 0.04em;
      opacity: 0.92;
      box-shadow: 0 8px 16px rgba(17, 24, 39, 0.18);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    .btn-annulla-unifica:hover{ transform: translateY(-1px); opacity: 1; box-shadow: 0 10px 18px rgba(17, 24, 39, 0.22); }


    .btn-unifica:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(239, 68, 68, 0.22);
    }
    .btn-unifica:active{
      transform: translateY(0);
      opacity: 0.95;
    }
    .card.unified{
      border-color: #38bdf8 !important;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.28), 0 8px 20px rgba(56, 189, 248, 0.18);
    }

    /* Modalit√† UNIFICA: metti in secondo piano le altre card */
    .unify-mode .card{
      opacity: 0.40;
      filter: saturate(0.85);
      transition: opacity 0.18s ease, filter 0.18s ease;
    }
    .unify-mode .card.unified{
      opacity: 1;
      filter: none;
    }

    /* Valore Unificato (ADMIN) */
    .unified-value{
      margin-top: 6px;
      font-size: 13px;
      font-weight: 800;
      color: #38bdf8;
      cursor: pointer;
      user-select: none;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .unified-value.is-hidden{ display:none; }

    .unified-value span{
      color: #38bdf8;
    }

  </style>
</head>
<body class="theme-minimal">
<canvas id="particle-bg"></canvas>
<!-- SPLASH -->
<div id="splash">
<div id="splash-logo">SEEMAX</div>
<div id="loading-bar"><div id="loading-fill"></div></div>
</div>
<div class="app-frame">
<div class="container">
<!-- HEADER -->
<header class="app-header">
<div class="brand-area">
<div class="brand-logo">S</div>
<div class="brand-text">
<span>Seemax Display</span>
<span>Led Lab Company</span>
</div>
</div>
<div class="heading-area">
<h1>CALCOLATORE LEDWALL</h1>
<p>‚ö†Ô∏èStrumento amministrativo TEMPORANEO per la pianificazione dei preventivi. PREZZI MODIFICATI‚ö†Ô∏è</p>
</div>
<div class="badge-area">
<div class="pill">
<span class="pill-dot"></span>
<span>Admin</span>
</div>
<div aria-label="Selettore stile interfaccia" class="theme-toggle">
<button class="theme-toggle-btn theme-toggle-btn--active" data-theme="minimal" type="button">Minimal</button>
<button class="theme-toggle-btn" data-theme="dark" type="button">Dark</button>
</div>
<span class="tag">Created by: David Failla</span>
</div>
</header>
<!-- LAYOUT PRINCIPALE -->
<div class="main-grid">
<!-- SINISTRA: INPUT -->
<section class="panel panel-inputs">
<div class="panel-header">
<h2>Parametri impianto</h2>
<p>Definisci dimensioni, tipologia installazione e provincia. ‚ö†Ô∏èATTENZIONE: IL P2.5 HA SUBITO UNA VARIAZIONE DI PREZZO PER TAMPONARE L'ASSENZA DEL P3.91‚ö†Ô∏è </p>
</div>
<div class="field-grid">
<div class="field">
<label class="field-label" for="base">Base (cm)</label>
<input id="base" placeholder="Es. 200" type="number"/>
</div>
<div class="field">
<label class="field-label" for="altezza">Altezza (cm)</label>
<input id="altezza" placeholder="Es. 200" type="number"/>
</div>
</div>
<div class="field">
<div class="field-toggle">
<input id="bifacciale" type="checkbox"/>
<div class="toggle-text">
<label for="bifacciale">Bifacciale</label>
<span>Raddoppia la superficie visualizzata (fronte/retro).</span>
</div>
</div>
</div>
<div class="field">
<label class="field-label" for="installazione">Installazione</label>
<div class="select-wrapper">
<select id="installazione">
<option selected="" value="personalizza">Da personalizzare</option>
<option value="parete">A parete</option>
<option value="bandiera">A bandiera</option>
<option value="palo">Su palo</option>
<option value="vetrina">A vetrina</option>
</select>
</div>
</div>
<div class="field">
<label class="field-label" for="provincia">Provincia installazione</label>
<div class="provincia-row">
<div class="select-wrapper" style="flex:1;">
<select id="provincia">
<option selected="" value="Catania">Catania (CT)</option>
<option value="Siracusa">Siracusa (SR)</option>
<option value="Enna">Enna (EN)</option>
<option value="Ragusa">Ragusa (RG)</option>
<option value="Messina">Messina (ME)</option>
<option value="Caltanissetta">Caltanissetta (CL)</option>
<option value="Agrigento">Agrigento (AG)</option>
<option value="Palermo">Palermo (PA)</option>
<option value="Trapani">Trapani (TP)</option>
</select>
</div>
<div class="provincia-pill" id="provinciaPill">+‚Ç¨ 0</div>
</div>
</div>
</section>
<!-- DESTRA: RISULTATI / CARDS -->
<section class="panel panel-results">
<div class="panel-header">
<h2>Soluzioni LEDWALL</h2>
<p>I modelli e i prezzi si aggiornano in base ai parametri inseriti.</p>
</div>
<div id="alertContainer"></div>
<div class="cards" id="cardsContainer"></div>
</section>
</div>
<!-- LAYOUT MODULI -->
<section class="panel panel-layout">
<div class="panel-header">
<h2>Schema moduli</h2>
<p>Visualizzazione semplificata dei cabinet necessari.</p>
</div>
<div id="layoutContainer"></div>
</section>
</div>
</div>
<script>
    // PARTICLE BACKGROUND
    const canvas = document.getElementById('particle-bg');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    for(let i=0;i<80;i++){
      particles.push({
        x:Math.random()*canvas.width,
        y:Math.random()*canvas.height,
        r:Math.random()*2+1,
        dx:(Math.random()-0.5)/2,
        dy:(Math.random()-0.5)/2
      });
    }
    function drawParticles(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle='rgba(0,198,255,0.3)';
        ctx.fill();
        p.x+=p.dx;
        p.y+=p.dy;
        if(p.x<0||p.x>canvas.width)p.dx*=-1;
        if(p.y<0||p.y>canvas.height)p.dy*=-1;
      });
      requestAnimationFrame(drawParticles);
    }
    drawParticles();

    // SPLASH SCREEN
    (function(){
      try{
        const splash = document.getElementById('splash');
        const fill = document.getElementById('loading-fill');
        if(!splash) return;

        let width = 0;
        let loaded = false;
        let done = false;

        function setWidth(v){
          width = Math.max(0, Math.min(100, v));
          if(fill) fill.style.width = width + '%';
        }

        function finish(){
          if(done) return;
          done = true;
          setWidth(100);
          setTimeout(()=>{ try{ splash.classList.add('hidden'); }catch(e){} }, 250);
        }

        const capBeforeLoad = 92;
        const interval = setInterval(()=>{
          if(done){ clearInterval(interval); return; }

          if(!loaded){
            if(width < capBeforeLoad) setWidth(width + 2);
          } else {
            if(width < 100) setWidth(width + 4);
            if(width >= 100){
              clearInterval(interval);
              finish();
            }
          }
        }, 30);

        window.addEventListener('load', ()=>{
          loaded = true;
        });

        // Fail-safe: force-complete the bar then hide (so it never stays stuck)
        setTimeout(()=>{ if(!done){ loaded = true; finish(); } }, 10000);
      }catch(e){
        try{ const s=document.getElementById('splash'); if(s) s.classList.add('hidden'); }catch(_ ){}
      }
    })();
// LISTINO
    const ledwalls = [
      { nome:"P1.9",  cabX:50, cabY:100, prezzoAgente:850, prezzoCliente:950, prezzoCina:560, info:"Ledwall Display P1.9 | Misura Cabinet: 0.50x1.00 | Indoor | COSTO CINA: 560‚Ç¨ (incl. 30% spedizione)", icon:"üñ•Ô∏è" },
      { nome:"P2.5",  cabX:64, cabY:64,  prezzoAgente:550, prezzoCliente:640, prezzoCina:450, info:"Ledwall Display P2.5 | 0.64x0.64 | In/Out | COSTO CINA: 450‚Ç¨ (incl. 30% spedizione) ‚ö†Ô∏èPREZZO MODIFICATO RIDOTTO DI 125 EURO PER TAMPONARE ASSENZA DI ALTRI SCHERMI - PREZZO ORIGINALE 675 - 765‚ö†Ô∏è", icon:"üñ•Ô∏è" },
      { nome:"P3",    cabX:57, cabY:57,  prezzoAgente:375, prezzoCliente:425, prezzoCina:250, info:"Ledwall Display P3 | 0.57x0.57 | In/Out | COSTO CINA: 250‚Ç¨", icon:"üñ•Ô∏è" },
      { nome:"P3.91", cabX:50, cabY:100, prezzoAgente:450, prezzoCliente:550, prezzoCina:280, info:"Ledwall Display P3.91 | 0.50x1.00 | In/Out | COSTO CINA: 280‚Ç¨", icon:"üñ•Ô∏è" },
      { nome:"P3.91 - 0.50x0.50", cabX:50, cabY:50, prezzoAgente:245, prezzoCliente:295, prezzoCina:150, info:"Ledwall Display P3.91 | 0.50x0.50 | In/Out | COSTO CINA: 150‚Ç¨", icon:"üñ•Ô∏è" },
      { nome:"P4",    cabX:96, cabY:96,  prezzoAgente:750, prezzoCliente:850, prezzoCina:580, info:"Ledwall Display P4 | 0.96x0.96 | Outdoor | COSTO CINA: 580‚Ç¨", icon:"üñ•Ô∏è" }
    ];

    // INSTALLAZIONE ‚Äì fasce fino a 20+
    const INSTALL_COSTS = [
      { th:1.5,  parete:500,  bandiera:500,  palo:500,  vetrina:400 },
      { th:2.0,  parete:650,  bandiera:600,  palo:600,  vetrina:500 },
      { th:2.75, parete:680,  bandiera:620,  palo:620,  vetrina:520 },
      { th:3.0,  parete:700,  bandiera:680,  palo:680,  vetrina:550 },
      { th:4.0,  parete:850,  bandiera:750,  palo:750,  vetrina:600 },
      { th:5.0,  parete:1000, bandiera:900,  palo:900,  vetrina:700 },
      { th:6.0,  parete:1100, bandiera:1000, palo:1000, vetrina:800 },
      { th:7.0,  parete:1200, bandiera:1100, palo:1100, vetrina:900 },
      { th:8.0,  parete:1300, bandiera:1200, palo:1200, vetrina:1000 },
      { th:9.0,  parete:1400, bandiera:1300, palo:1300, vetrina:1100 },
      { th:15.0, parete:1550, bandiera:1450, palo:1450, vetrina:1200 },
      { th:20.0, parete:1800, bandiera:1650, palo:1650, vetrina:1500 },
      { th:1e9,  parete:2000, bandiera:1950, palo:1950, vetrina:1800 }
    ];
    function installCost(areaMq, tipo){
      if(tipo==='personalizza') return 0;
      let rec = INSTALL_COSTS.find(r => areaMq <= r.th) || INSTALL_COSTS[INSTALL_COSTS.length-1];
      switch(tipo){
        case 'parete':   return rec.parete;
        case 'bandiera': return rec.bandiera;
        case 'palo':     return rec.palo;
        case 'vetrina':  return rec.vetrina;
        default:         return 0;
      }
    }

    // Provincia ‚Äì km da Catania e costo/km
    const PROVINCE_KM = {
      Catania:0, Siracusa:51, Enna:71, Ragusa:72,
      Messina:87, Caltanissetta:90, Agrigento:135,
      Palermo:166, Trapani:231
    };
    const COSTO_KM = 2.0;

    // DOM refs
    const baseInput = document.getElementById('base');
    const altezzaInput = document.getElementById('altezza');
    const bifaccialeInput = document.getElementById('bifacciale');
    const installazioneSelect = document.getElementById('installazione');
    const provinciaSelect = document.getElementById('provincia');
    const provinciaPill = document.getElementById('provinciaPill');
    const cardsContainer = document.getElementById('cardsContainer');
    const alertContainer = document.getElementById('alertContainer');
    const layoutContainer = document.getElementById('layoutContainer');
    const whatsappNumber = "393294397445";

    let currentPopup = null;

    function setProvinciaPill(){
      const km = PROVINCE_KM[provinciaSelect.value] || 0;
      const euro = km * COSTO_KM;
      const maxEuro = PROVINCE_KM['Trapani'] * COSTO_KM;
      const ratio = Math.min(1, euro/maxEuro);
      const hue = 120 - (120*ratio); // verde->rosso
      provinciaPill.style.backgroundColor = `hsl(${hue},85%,45%)`;
      provinciaPill.textContent = `+‚Ç¨ ${Math.round(euro).toLocaleString('it-IT')}`;
      provinciaPill.title = `Sovrapprezzo trasferta (${km} km √ó ‚Ç¨${COSTO_KM.toFixed(2)}/km)`;
    }

    function animateValue(el,start,end,duration){
      let t0=null;
      const step=(t)=>{
        if(!t0)t0=t;
        const p=Math.min((t-t0)/duration,1);
        el.textContent=Math.floor(start+(end-start)*p).toLocaleString('it-IT');
        if(p<1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function aggiornaLayout(models, rotatedMatchFlag){
      layoutContainer.innerHTML = "";
      if(!models) return;

      const arr = Array.isArray(models) ? models.slice() : [models];

      // Unifica layout P1.9 / P3.91 SOLO per i cabinet 0.50x1.00
      const groupRect = arr.filter(m => (m.cabX===50 && m.cabY===100) && (m.nome==='P1.9' || m.nome==='P3.91'));
      const others = arr.filter(m => !groupRect.includes(m));

      if(groupRect.length){
        const hasP19 = groupRect.some(m=>m.nome==='P1.9');
        const hasP391 = groupRect.some(m=>m.nome==='P3.91');
        const title = (hasP19 && hasP391) ? 'Layout suggerito per P1.9 / P3.91' : `Layout suggerito per ${groupRect[0].nome}`;
        layoutContainer.innerHTML += `<h3>${title}</h3>`;
        const baseModel = groupRect.find(m=>m.nome==='P1.9') || groupRect[0];
        generaLayout(baseModel, rotatedMatchFlag);
      }

      // Tutti gli altri modelli (incluso P3.91 - 0.50x0.50) restano separati
      others.forEach(m=>{
        layoutContainer.innerHTML += `<h3>Layout suggerito per ${m.nome}</h3>`;
        generaLayout(m, rotatedMatchFlag);
      });

      if(rotatedMatchFlag){
        const warn=document.createElement('div');
        warn.className='alert';
        warn.innerHTML='‚ö†Ô∏è √à possibile ruotare alcuni cabinet verticali in maniera orizzantale per ottenere questa misura ma non √® consigliato.';
        layoutContainer.appendChild(warn);
      }
    }

    function generaLayout(model, rotatedMatchFlag){
      const bif=bifaccialeInput.checked;
      const layout=document.createElement('div');
      layout.style.display='grid';
      layout.style.gridGap='2px';
      layout.style.justifyContent='center';

      const isRect = model.cabX===50 && model.cabY===100;
      const blockW = isRect && rotatedMatchFlag ? 26 : 18;
      const blockH = isRect && rotatedMatchFlag ? 18 : (isRect ? 26 : 18);

      const base=parseFloat(baseInput.value)||0;
      const alt=parseFloat(altezzaInput.value)||0;
      let cols = rotatedMatchFlag && isRect ? Math.ceil(base/model.cabY) : Math.ceil(base/model.cabX);
      let rows = rotatedMatchFlag && isRect ? Math.ceil(alt/model.cabX) : Math.ceil(alt/model.cabY);

      layout.style.gridTemplateColumns=`repeat(${cols}, ${blockW}px)`;
      layout.style.gridTemplateRows=`repeat(${rows}, ${blockH}px)`;

      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell=document.createElement('div');
          cell.style.width=`${blockW}px`;
          cell.style.height=`${blockH}px`;
          cell.style.margin='1px';
          cell.style.borderRadius='4px';
          cell.style.backgroundColor=bif?'#fecaca':'#bfdbfe';
          layout.appendChild(cell);
        }
      }
      layoutContainer.appendChild(layout);
    }


    // Layout unificato P3.91: cabinet 0.50x1.00 + 0.50x0.50 (solo quando necessario)
    function generaLayoutUnificatoP391(plan){
      const bif = bifaccialeInput.checked;

      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.flexDirection = 'column';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '2px';

      function cell(w,h){
        const d = document.createElement('div');
        d.style.width = w + 'px';
        d.style.height = h + 'px';
        d.style.borderRadius = '4px';
        d.style.margin = '1px';
        d.style.backgroundColor = bif ? '#fecaca' : '#bfdbfe';
        if(bif) d.style.border = '1px solid #fca5a5';
        return d;
      }

      // Quadrati (0.50x0.50) in alto
      for(let r=0; r<plan.squareRows; r++){
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'center';
        for(let c=0; c<plan.cols; c++){
          row.appendChild(cell(18,18));
        }
        wrap.appendChild(row);
      }

      // Rettangoli (0.50x1.00) sotto
      for(let rr=0; rr<plan.rectRows; rr++){
        const row2 = document.createElement('div');
        row2.style.display = 'flex';
        row2.style.justifyContent = 'center';
        for(let c2=0; c2<plan.cols; c2++){
          row2.appendChild(cell(18,26));
        }
        wrap.appendChild(row2);
      }

      layoutContainer.appendChild(wrap);
    }


    function aggiornaCards(){
      const base = parseFloat(baseInput.value);
      const altezza = parseFloat(altezzaInput.value);
      const bif=bifaccialeInput.checked;
      const tipoInst=installazioneSelect.value;

      cardsContainer.innerHTML='';
      alertContainer.innerHTML='';
      layoutContainer.innerHTML='';
      setProvinciaPill();

      if(!base || !altezza) return;

      const kmSelezionati = PROVINCE_KM[provinciaSelect.value] || 0;
      const extraKm = kmSelezionati * COSTO_KM;

      let results = ledwalls.map(model=>{
        const isRect = model.cabX===50 && model.cabY===100;
        let perfect=false, rotated=false;
        if(isRect){
          perfect=(base%model.cabX===0 && altezza%model.cabY===0);
          rotated=(!perfect && (base%model.cabY===0 && altezza%model.cabX===0));
        } else {
          perfect=(base%model.cabX===0 && altezza%model.cabY===0);
          rotated=false;
        }

        const cols = rotated? Math.ceil(base/model.cabY) : Math.ceil(base/model.cabX);
        const rows = rotated? Math.ceil(altezza/model.cabX) : Math.ceil(altezza/model.cabY);

        let totalCab = cols*rows;
        let prezzoClienteBase = totalCab * model.prezzoCliente; // solo display
        let prezzoAgenteBase  = totalCab * model.prezzoAgente;  // solo display
        let margineCliente    = prezzoClienteBase - (totalCab * model.prezzoCina);
        let margineAgente     = prezzoAgenteBase  - (totalCab * model.prezzoCina);

        if(bif){
          totalCab*=2;
          prezzoClienteBase*=2;
          prezzoAgenteBase*=2;
          margineCliente*=2;
          margineAgente*=2;
        }

        const displayWidth = cols*(rotated?model.cabY:model.cabX);
        const displayHeight= rows*(rotated?model.cabX:model.cabY);

        const areaMq = (displayWidth/100) * (displayHeight/100);
        const extraInstall = installCost(areaMq, tipoInst);

        const prezzoClienteTotale = prezzoClienteBase + extraInstall + extraKm;
        const prezzoAgenteTotale  = prezzoAgenteBase  + extraInstall + extraKm;

        const diffX=Math.abs(base - displayWidth);
        const diffY=Math.abs(altezza - displayHeight);
        const diff=diffX+diffY;

        return {
          ...model,
          colsNeeded:cols,
          rowsNeeded:rows,
          totalCab,
          prezzoClienteTotale,
          prezzoAgenteTotale,
          margineCliente,
          margineAgente,
          margineInstallazione: extraInstall,
          margineKm: extraKm,
          diff,
          perfectMatch:perfect,
          rotatedMatch:rotated,
          displayWidth,
          displayHeight,
          nearestBase: Math.round(base/model.cabX)*model.cabX,
          nearestAltezza: Math.round(altezza/model.cabY)*model.cabY,
          bifacciale:bif,
          prezzoTotale: prezzoClienteTotale
        };
      });

      const perfectMatches = results.filter(r=>r.perfectMatch);
      const rotatedMatches = results.filter(r=>r.rotatedMatch);
      const bestMatch = results.reduce((p,c)=> c.diff<p.diff?c:p);

      results.sort((a,b)=>{
        if(a.perfectMatch&&!b.perfectMatch) return -1;
        if(!a.perfectMatch&&b.perfectMatch) return 1;
        return (a.diff+a.prezzoTotale*0.0001)-(b.diff+b.prezzoTotale*0.0001);
      });

      const bestPriceModel = results.reduce((p,c)=> c.prezzoTotale<p.prezzoTotale?c:p);

      // UNIFICA CABINET (solo P3.91: 0.50x1.00 + 0.50x0.50)
      let unificaPlan = null;
      let unificaDisponibile = false;
      const cardMap = {};

      (function(){
        try{
          const condMisure = (base % 50 === 0) && (altezza % 100 === 50) && (altezza >= 150);
          const rectModel = results.find(r => r.nome === 'P3.91' && r.cabX === 50 && r.cabY === 100);
          const sqModel   = results.find(r => r.nome === 'P3.91 - 0.50x0.50' && r.cabX === 50 && r.cabY === 50);
          const hasSquarePerfect = perfectMatches.some(r => r.nome === 'P3.91 - 0.50x0.50' && r.cabX === 50 && r.cabY === 50);

          if(condMisure && rectModel && sqModel && hasSquarePerfect){
            const colsU = base / 50;
            const rectRowsU = (altezza - 50) / 100; // sempre intero per condMisure
            const rectCabU = colsU * rectRowsU;
            const sqCabU   = colsU * 1;

            // solo display (prima del bifacciale)
            let dispCliente = (rectCabU * rectModel.prezzoCliente) + (sqCabU * sqModel.prezzoCliente);
            let dispAgente  = (rectCabU * rectModel.prezzoAgente)  + (sqCabU * sqModel.prezzoAgente);
            let dispCina    = (rectCabU * rectModel.prezzoCina)    + (sqCabU * sqModel.prezzoCina);

            let rectCabDisp = rectCabU;
            let sqCabDisp   = sqCabU;

            if(bif){
              dispCliente *= 2;
              dispAgente  *= 2;
              dispCina    *= 2;
              rectCabDisp *= 2;
              sqCabDisp   *= 2;
            }

            const areaMqU = (base/100) * (altezza/100);
            const extraInstallU = installCost(areaMqU, tipoInst);

            const prezzoClienteTot = dispCliente + extraInstallU + extraKm;
            const prezzoAgenteTot  = dispAgente  + extraInstallU + extraKm;

            unificaPlan = {
              cols: colsU,
              rectRows: rectRowsU,
              squareRows: 1,
              rectCab: rectCabDisp,
              sqCab: sqCabDisp,
              rectUnitPriceCliente: rectModel.prezzoCliente,
              sqUnitPriceCliente: sqModel.prezzoCliente,
              rectUnitPriceAgente: rectModel.prezzoAgente,
              sqUnitPriceAgente: sqModel.prezzoAgente,
              rectUnitPriceCina: rectModel.prezzoCina,
              sqUnitPriceCina: sqModel.prezzoCina,
              displayCliente: dispCliente,
              displayAgente: dispAgente,
              displayCina: dispCina,
              extraInstall: extraInstallU,
              extraKm: extraKm,
              prezzoClienteTotale: prezzoClienteTot,
              prezzoAgenteTotale: prezzoAgenteTot,
              bifacciale: bif
            };
            unificaDisponibile = true;
          }
        }catch(e){}
      })();

      function applicaUnificaP391(){
        if(!unificaPlan) return;

        

         if(cardsContainer && cardsContainer.classList){ cardsContainer.classList.add('unify-mode'); }
         // mostra 'Valore Unificato' solo dopo il click su UNIFICA
         document.querySelectorAll('.unified-value.is-hidden').forEach(function(el){ el.classList.remove('is-hidden'); });
// evidenzia le card coinvolte
        Object.keys(cardMap).forEach(k=>{
          if(cardMap[k] && cardMap[k].classList) cardMap[k].classList.remove('unified');
        });
        if(cardMap['P3.91']) cardMap['P3.91'].classList.add('unified');
        if(cardMap['P3.91 - 0.50x0.50']) cardMap['P3.91 - 0.50x0.50'].classList.add('unified');

        // layout dedicato
        layoutContainer.innerHTML = '';
        const h = document.createElement('h3');
        h.textContent = 'Layout suggerito per P3.91 Unificato';
        layoutContainer.appendChild(h);
        generaLayoutUnificatoP391(unificaPlan);

        const rectCabBase = unificaPlan.rectCab / (unificaPlan.bifacciale ? 2 : 1);
        const sqCabBase   = unificaPlan.sqCab   / (unificaPlan.bifacciale ? 2 : 1);

        let txt = '‚úÖ Modalit√† UNIFICA attiva: ' + rectCabBase + ' cabinet 0.50x1.00 + ' + sqCabBase + ' cabinet 0.50x0.50.';
        if(unificaPlan.bifacciale) txt += ' (Bifacciale: quantit√† e prezzo raddoppiati)';
        txt += ' Valore unificato (cliente): <strong>' + Math.round(unificaPlan.prezzoClienteTotale).toLocaleString('it-IT') + '‚Ç¨</strong>.';

        alertContainer.innerHTML = '<div class="alert" style="border-left:3px solid #ef4444;">' + txt + '</div>';
       

       function annullaUnificaP391(){
         try{
           if(cardsContainer && cardsContainer.classList){ cardsContainer.classList.remove('unify-mode'); }
         }catch(e){}
         try{
           document.querySelectorAll('.card.unified').forEach(function(c){ c.classList.remove('unified'); });
         }catch(e){}
         try{
           document.querySelectorAll('.unified-value').forEach(function(el){
             if(!el.classList.contains('is-hidden')) el.classList.add('is-hidden');
           });
         }catch(e){}
         try{ alertContainer.innerHTML = ''; }catch(e){}
         try{ aggiornaCards(); }catch(e){}
       }

  // Pulsante ANNULLA UNIFICA
         try{
           var btnWrap = document.createElement('div');
           btnWrap.style.marginTop = '10px';
           var btnA = document.createElement('button');
           btnA.type = 'button';
           btnA.className = 'btn-annulla-unifica';
           btnA.textContent = 'ANNULLA UNIFICA';
           btnA.addEventListener('click', function(ev){
             ev.preventDefault(); ev.stopPropagation();
             if(ev.stopImmediatePropagation) ev.stopImmediatePropagation();
             annullaUnificaP391();
           }, {capture:true});
           btnWrap.appendChild(btnA);
           var target = alertContainer.querySelector('.alert');
           (target || alertContainer).appendChild(btnWrap);
         }catch(e){}

      }

      function mostraDettagliValoreUnificato(e){
        e.stopPropagation();
        if(!unificaPlan) return;

        const rectCabBase = unificaPlan.rectCab / (unificaPlan.bifacciale ? 2 : 1);
        const sqCabBase   = unificaPlan.sqCab   / (unificaPlan.bifacciale ? 2 : 1);

        const detail = [
          '<div class="alert" style="border-left:3px solid #60a5fa;">',
          '<strong>Dettagli Valore Unificato</strong><br>',
          'Cabinet 0.50x1.00: <strong>' + rectCabBase + '</strong> √ó ' + unificaPlan.rectUnitPriceCliente + '‚Ç¨ (cliente) / ' + unificaPlan.rectUnitPriceAgente + '‚Ç¨ (agente)<br>',
          'Cabinet 0.50x0.50: <strong>' + sqCabBase + '</strong> √ó ' + unificaPlan.sqUnitPriceCliente + '‚Ç¨ (cliente) / ' + unificaPlan.sqUnitPriceAgente + '‚Ç¨ (agente)<br>',
          'Installazione: <strong>' + Math.round(unificaPlan.extraInstall).toLocaleString('it-IT') + '‚Ç¨</strong><br>',
          'Trasferta: <strong>' + Math.round(unificaPlan.extraKm).toLocaleString('it-IT') + '‚Ç¨</strong><br>',
          'Totale Cliente: <strong>' + Math.round(unificaPlan.prezzoClienteTotale).toLocaleString('it-IT') + '‚Ç¨</strong><br>',
          'Totale Agente: <strong>' + Math.round(unificaPlan.prezzoAgenteTotale).toLocaleString('it-IT') + '‚Ç¨</strong>',
          '</div>'
        ].join('');
        alertContainer.innerHTML = detail;
      }


      results.forEach(model=>{
        const wrapper=document.createElement('div');
        wrapper.style.display='flex';
        wrapper.style.flexDirection='column';
        wrapper.style.alignItems='stretch';

        const card=document.createElement('div');
        if(model.perfectMatch) card.className='card green';
        else if(model.rotatedMatch) card.className='card yellow';
        else card.className='card red';
        if(model.nome===bestPriceModel.nome) card.classList.add('best');
        cardMap[model.nome] = card;

        const popup=document.createElement('div');
        popup.className='card-popup';
        popup.innerHTML=`<strong>${model.nome}</strong><br>${model.info}`;
        card.appendChild(popup);

        const whatsappLink=`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(
          (model.perfectMatch||model.rotatedMatch)
          ? `Ti contatto dal calcolatore ADMIN per il modello ${model.nome} con misura ${base} x ${altezza}${model.bifacciale?" (Bifacciale)":""}.`
          : `Ti contatto dal calcolatore ADMIN per un preventivo personalizzato con modello ${model.nome} e misura ${base} x ${altezza}${model.bifacciale?" (Bifacciale)":""}.`
        )}`;

        card.innerHTML += `
          <div class="card-header-row">
            <div class="card-title-block">
              <div class="card-icon">${model.icon}</div>
              <h2>${model.nome}</h2>
            </div>
          </div>
          <p class="tooltip">Dimensione cabinet: ${model.cabX} √ó ${model.cabY} cm
            <span class="tooltiptext">${model.info}</span>
          </p>
          ${(model.perfectMatch||model.rotatedMatch)?`
            <p class="cabinet">Numero cabinet: <span id="cab${model.nome}">0</span></p>
            <p class="price">Prezzo agente: <span id="priceAgent${model.nome}">0</span>‚Ç¨</p>
            <p class="priceClient">Prezzo cliente: <span id="priceClient${model.nome}">0</span>‚Ç¨</p>
            <p class="margin">Margine su agente: <span id="marginAgent${model.nome}">0</span>‚Ç¨</p>
            <p class="marginClient">Margine su cliente: <span id="marginClient${model.nome}">0</span>‚Ç¨</p>
            <p class="marginInstall">Margine installazione: <span id="marginInst${model.nome}">0</span>‚Ç¨</p>
            <p class="marginKm">Margine km: <span id="marginKm${model.nome}">0</span>‚Ç¨</p>
            ${model.bifacciale?`<p class="bifacciale-label">Bifacciale</p>`:''}
          `:`<p>Misura pi√π vicina: ${model.nearestBase} √ó ${model.nearestAltezza} cm</p>`}
        
        `;

        // Pulsante UNIFICA (solo P3.91)
        if(unificaDisponibile && (model.nome==='P3.91' || model.nome==='P3.91 - 0.50x0.50')){
          const header = card.querySelector('.card-header-row');
          if(header){
            const btnUnifica = document.createElement('button');
            btnUnifica.className = 'btn-unifica';
            btnUnifica.type = 'button';
            btnUnifica.textContent = 'UNIFICA CABINET';
            btnUnifica.addEventListener('click', (e)=>{ e.stopPropagation(); applicaUnificaP391(); });
            header.appendChild(btnUnifica);
          }

          // Valore Unificato (cliccabile)
          if(unificaPlan){
            const pUni = document.createElement('p');
            pUni.className = 'unified-value is-hidden';
            pUni.innerHTML = `Valore Unificato: <span>${Math.round(unificaPlan.prezzoClienteTotale).toLocaleString('it-IT')}‚Ç¨</span>`;
            pUni.addEventListener('click', mostraDettagliValoreUnificato);
            card.appendChild(pUni);
          }
        }

        const btn=document.createElement('button');

        btn.className='btn-request';
        btn.textContent='Richiedi preventivo';
        btn.onclick=()=>window.open(whatsappLink,'_blank');

        card.addEventListener('click',(e)=>{
          if(e.target.classList && e.target.classList.contains('btn-request')) return;
          if(currentPopup && currentPopup!==card){
            currentPopup.classList.remove('show-popup');
          }
          card.classList.toggle('show-popup');
          currentPopup = card.classList.contains('show-popup') ? card : null;
        });

        wrapper.appendChild(card);
        wrapper.appendChild(btn);
        cardsContainer.appendChild(wrapper);

        if(model.perfectMatch || model.rotatedMatch){
          setTimeout(()=>{
            animateValue(document.getElementById(`cab${model.nome}`),0,model.totalCab,1200);
            animateValue(document.getElementById(`priceAgent${model.nome}`),0,Math.round(model.prezzoAgenteTotale),1200);
            animateValue(document.getElementById(`priceClient${model.nome}`),0,Math.round(model.prezzoClienteTotale),1200);
            animateValue(document.getElementById(`marginAgent${model.nome}`),0,Math.round(model.margineAgente),1200);
            animateValue(document.getElementById(`marginClient${model.nome}`),0,Math.round(model.margineCliente),1200);
            animateValue(document.getElementById(`marginInst${model.nome}`),0,Math.round(model.margineInstallazione),1200);
            animateValue(document.getElementById(`marginKm${model.nome}`),0,Math.round(model.margineKm),1200);
          },50);
        }
      });

      if(rotatedMatches.length>0){
        alertContainer.innerHTML=`<div class="alert">‚ö†Ô∏è E' possibile ruotare alcuni cabinet verticali in maniera orizzantale per ottenere questa misura ma non √® consigliato.</div>`;
        aggiornaLayout(rotatedMatches,true);
      }
      else if(perfectMatches.length===0){
        alertContainer.innerHTML = `
          <div class="alert">
            Per questa misura ti consigliamo un <strong>${bestMatch.nome}</strong>
            con misure realizzabili ${bestMatch.displayWidth} √ó ${bestMatch.displayHeight} cm.<br>
            Puoi richiedere un preventivo personalizzato cliccando
            <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(
              `Ti contatto dal calcolatore ADMIN per un preventivo personalizzato con misura ${base} x ${altezza}${(bif? ' (Bifacciale)':'')}.`
            )}" target="_blank">qui</a>.
          </div>`;
        aggiornaLayout([bestMatch],false);
      }
      else {
        aggiornaLayout(perfectMatches,false);
      }
    }

    baseInput.addEventListener('input', aggiornaCards);
    altezzaInput.addEventListener('input', aggiornaCards);
    bifaccialeInput.addEventListener('change', aggiornaCards);
    installazioneSelect.addEventListener('change', aggiornaCards);
    provinciaSelect.addEventListener('change', ()=>{
      setProvinciaPill();
      aggiornaCards();
    });
    setProvinciaPill();

    // Effetto luce sui moduli
    setInterval(()=>{
      const cells=document.querySelectorAll('#layoutContainer > div > div');
      cells.forEach((cell,i)=>{
        const pulse=Math.sin(Date.now()/400+i)*0.4+0.6;
        cell.style.filter=`brightness(${pulse})`;
      });
    },80);

    // === TEMA (Minimal / Dark) ===
    const THEME_KEY = 'seemax_admin_theme_style';
    const themeButtons = document.querySelectorAll('.theme-toggle-btn');

    function applyTheme(theme) {
      const t = theme === 'dark' ? 'dark' : 'minimal';
      document.body.classList.remove('theme-minimal','theme-dark');
      document.body.classList.add('theme-' + t);
      themeButtons.forEach(btn => {
        btn.classList.toggle('theme-toggle-btn--active', btn.dataset.theme === t);
      });
      try { localStorage.setItem(THEME_KEY, t); } catch(e) {}
    }

    themeButtons.forEach(btn => {
      btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
    });

    (function initTheme(){
      let saved = 'minimal';
      try {
        const stored = localStorage.getItem(THEME_KEY);
        if(stored === 'dark' || stored === 'minimal') saved = stored;
      } catch(e) {}
      applyTheme(saved);
    })();
  </script>
</body>
</html>
