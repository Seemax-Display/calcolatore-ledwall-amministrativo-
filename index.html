<!-- Versione AMMINISTRATIVA 1.3.2 ‚Äì Fix: Provincia/Installazione sommate in Prezzo Agente/Cliente -->
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calcolatore Ledwall Ufficiale Seemax ‚Äì Admin 1.3.2</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<style>
/* BODY & CONTAINER */
body { margin:0; padding:0; font-family:'Roboto',sans-serif; background:linear-gradient(160deg,#0a1b2a,#112f4a); color:#e0e0e0; overflow-x:hidden; }
.container { max-width:1000px; margin:50px auto; background:rgba(20,30,50,0.9); padding:60px 50px; border-radius:25px; box-shadow:0 20px 50px rgba(0,0,0,0.6); }

/* HEADER */
h1 { text-align:center; color:#00c6ff; font-size:44px; margin-bottom:10px; text-shadow:0 0 8px #00c6ff; }
h3 { text-align:center; color:#b0cfff; font-weight:normal; font-size:20px; margin-bottom:30px; }

/* INPUT */
.input-group { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; }
.input-group div { flex:1 1 200px; }
.input-group label { display:block; font-weight:bold; color:#00aaff; margin-bottom:5px; font-size:16px; }
.input-group input, .input-group select { width:100%; padding:15px; font-size:16px; border-radius:12px; border:1px solid #004b8d; background:rgba(0,75,141,0.1); color:#fff; transition:all 0.3s ease; }
.input-group input:focus, .input-group select:focus { border-color:#00c6ff; box-shadow:0 0 20px rgba(0,198,255,0.5); outline:none; }

/* CARDS */
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:30px; margin-top:30px; }
.card { position:relative; background:linear-gradient(145deg,#112f4a,#0a1b2a); border-radius:20px; padding:25px; box-shadow:0 12px 35px rgba(0,0,0,0.5), 0 0 10px rgba(0,198,255,0.2) inset; text-align:center; transition:transform 0.5s ease, box-shadow 0.5s ease; cursor:pointer; overflow:hidden; }
.card::before { content:""; position:absolute; inset:0; background-image:radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px); background-size:12px 12px; border-radius:20px; pointer-events:none; }
.card.green { border-left:6px solid #00ff99; }
.card.red { border-left:6px solid #ff5252; }
.card.yellow { border-left:6px solid #ffc107; }
.card.best { border:3px solid #00c6ff; box-shadow:0 0 25px #00c6ff; }
.card:hover { transform:translateY(-12px) scale(1.05) rotateZ(1deg); box-shadow:0 25px 55px rgba(0,0,0,0.6), 0 0 25px #00c6ff inset; }
.card-icon { font-size:50px; color:#00c6ff; margin-bottom:15px; text-shadow:0 0 10px #00c6ff; transition:transform 0.3s ease; }
.card:hover .card-icon { transform:scale(1.2) rotate(-5deg); }
.card h2 { color:#00c6ff; margin-bottom:12px; font-size:26px; text-shadow:0 0 6px rgba(0,198,255,0.7); }
.card p { font-size:16px; margin:6px 0; }
/* PRICE, PRICECLIENT, CABINET - gradient blu */
.card .price, .card .priceClient, .card .cabinet { font-weight:bold; font-size:20px; background:linear-gradient(90deg,#00ffcc,#00aaff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 2px 6px rgba(0,0,0,0.4); }
/* MARGINI verdi */
.card .margin, .card .marginClient, .card .marginInstall, .card .marginKm { font-weight:bold; font-size:20px; color:#04fc00; text-shadow:0 2px 6px rgba(0,0,0,0.4); background:none; -webkit-background-clip:unset; -webkit-text-fill-color:unset; }
.card.show .price, .card.show .cabinet { opacity:1; transform:translateY(0); }
.card .bifacciale-label { color:#ff5252; font-weight:bold; margin-top:10px; font-size:18px; }

/* BUTTON */
.btn-request { margin-top:18px; padding:12px 22px; font-size:16px; background:#004b8d; color:#fff; border:none; border-radius:12px; cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(0,75,141,0.4); }
.btn-request:hover { background:#00c6ff; box-shadow:0 0 25px #00c6ff, 0 6px 20px rgba(0,198,255,0.5); transform:translateY(-3px) scale(1.05); }

/* TOOLTIP */
.tooltip { position:relative; cursor:pointer; border-bottom:1px dotted #00c6ff; }
.tooltip .tooltiptext { visibility:hidden; width:240px; background-color:#00c6ff; color:#000; text-align:center; border-radius:8px; padding:10px; position:absolute; z-index:1; bottom:130%; left:50%; margin-left:-120px; opacity:0; transition:opacity 0.4s, transform 0.4s; transform:translateY(10px); font-size:14px; }
.tooltip:hover .tooltiptext { visibility:visible; opacity:1; transform:translateY(0); }

/* POPUP */
.card-popup { position:absolute; top:10px; left:10px; right:10px; bottom:10px; background:rgba(0,50,90,0.95); color:#fff; padding:15px; border-radius:15px; display:block; opacity:0; transform:translateY(20px); z-index:10; font-size:14px; overflow-y:auto; transition:opacity 0.4s ease, transform 0.4s ease; }
.card.show-popup .card-popup { opacity:1; transform:translateY(0); }

/* ALERT */
.alert { text-align:center; margin-top:30px; padding:20px; background:#221111; color:#ff5252; border-radius:15px; font-size:18px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
.alert a { color:#00c6ff; font-weight:bold; text-decoration:none; }
.alert a:hover { text-decoration:underline; }

/* LAYOUT */
#layoutContainer { margin-top:40px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:15px; }
#layoutContainer h3 { color:#00c6ff; text-shadow:0 0 10px #00c6ff; margin-bottom:15px; }

/* SPLASH */
#splash{ position:fixed; inset:0; background:#0a1b2a; display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:9999; opacity:1; transition:opacity 0.8s ease; }
#splash.hidden{ opacity:0; pointer-events:none; }
#splash-logo{ font-size:60px; color:#00c6ff; text-shadow:0 0 15px #00c6ff; transform:scale(0.8); animation:logoReveal 1s forwards; margin-bottom:20px; }
@keyframes logoReveal{ 0%{opacity:0; transform:scale(0.5);} 100%{opacity:1; transform:scale(1);} }
#loading-bar{ width:300px; height:8px; border-radius:4px; background:rgba(255,255,255,0.2); overflow:hidden; }
#loading-fill{ width:0%; height:100%; background:#00c6ff; transition:width 0.3s ease; }

/* PARTICLE BG */
#particle-bg{ position:fixed; inset:0; z-index:0; pointer-events:none; }

/* Select temi scuri */
#installazione, #provincia { color:#fff; background-color:rgba(0,75,141,0.1); border-color:#004b8d; }
#installazione:focus, #provincia:focus { outline:2px solid #00c6ff; box-shadow:0 0 12px rgba(0,198,255,0.35); }
#installazione option, #provincia option { background:#0f1f33; color:#fff; }
#installazione option:checked, #provincia option:checked { background:#00c6ff; color:#00111c; }
#installazione option:hover, #provincia option:hover { background:#123b5a; color:#fff; }

/* Provincia pill (verde->rosso) */
.provincia-row{ display:flex; align-items:center; gap:12px; }
.provincia-pill{ padding:8px 12px; border-radius:999px; font-weight:700; font-size:14px; color:#fff; background:#00a651; min-width:120px; text-align:right; margin-left:auto; box-shadow:0 6px 18px rgba(0,0,0,0.2); }
</style>
</head>
<body>
<canvas id="particle-bg"></canvas>
<div id="splash"><div id="splash-logo">SEEMAX</div><div id="loading-bar"><div id="loading-fill"></div></div></div>

<div class="container">
  <h1>Calcolatore Ledwall Ufficiale Seemax</h1>
  <h3>Calcola e pianifica i tuoi preventivi in maniera dettagliata</h3>

  <div class="input-group">
    <div>
      <label for="base">Base (cm):</label>
      <input type="number" id="base" placeholder="Es. 200" />
    </div>
    <div>
      <label for="altezza">Altezza (cm):</label>
      <input type="number" id="altezza" placeholder="Es. 200" />
    </div>
    <div style="display:flex; align-items:center; gap:10px; margin-top:30px;">
      <input type="checkbox" id="bifacciale" />
      <label for="bifacciale" style="font-weight:bold; color:#00aaff; cursor:pointer;">Bifacciale</label>
    </div>
  </div>

  <!-- Tipo Installazione -->
  <div class="input-group" aria-label="Tipo Installazione">
    <div style="flex:1 1 100%">
      <label for="installazione">Installazione</label>
      <select id="installazione">
        <option value="personalizza" selected>Da Personalizzare</option>
        <option value="parete">A parete</option>
        <option value="bandiera">A bandiera</option>
        <option value="palo">Su Palo</option>
        <option value="vetrina">A vetrina</option>
      </select>
    </div>
  </div>
  
  <!-- Provincia Installazione con pill -->
  <div class="input-group" aria-label="Provincia Installazione">
    <div style="flex:1 1 100%">
      <label for="provincia">Provincia installazione</label>
      <div class="provincia-row">
        <select id="provincia">
          <option value="Catania" selected>Catania (CT)</option>
          <option value="Siracusa">Siracusa (SR)</option>
          <option value="Enna">Enna (EN)</option>
          <option value="Ragusa">Ragusa (RG)</option>
          <option value="Messina">Messina (ME)</option>
          <option value="Caltanissetta">Caltanissetta (CL)</option>
          <option value="Agrigento">Agrigento (AG)</option>
          <option value="Palermo">Palermo (PA)</option>
          <option value="Trapani">Trapani (TP)</option>
        </select>
        <div id="provinciaPill" class="provincia-pill">+‚Ç¨ 0</div>
      </div>
    </div>
  </div>

  <div id="alertContainer"></div>
  <div class="cards" id="cardsContainer"></div>
  <div id="layoutContainer"></div>
</div>

<script>
// PARTICLE BACKGROUND
const canvas = document.getElementById('particle-bg');
const ctx = canvas.getContext('2d');
let particles = [];
function resizeCanvas(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
window.addEventListener('resize', resizeCanvas); resizeCanvas();
for(let i=0;i<80;i++){particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*2+1, dx:(Math.random()-0.5)/2, dy:(Math.random()-0.5)/2});}
function drawParticles(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle='rgba(0,198,255,0.3)'; ctx.fill(); p.x+=p.dx; p.y+=p.dy; if(p.x<0||p.x>canvas.width)p.dx*=-1; if(p.y<0||p.y>canvas.height)p.dy*=-1; }); requestAnimationFrame(drawParticles); }
drawParticles();

// SPLASH SCREEN
const splash = document.getElementById('splash');
const fill = document.getElementById('loading-fill');
let width = 0;
const interval = setInterval(()=>{ width += 2; fill.style.width = width + '%'; if(width >= 100){ clearInterval(interval); setTimeout(()=>{ splash.classList.add('hidden'); },300); } },30);

// LISTINO
const ledwalls = [
  { nome:"P1.9",  cabX:50, cabY:100, prezzoAgente:850, prezzoCliente:950, prezzoCina:560, info:"Ledwall Display P1.9 | Misura Cabinet: 0.50x1.00 | Indoor | COSTO CINA: 560‚Ç¨ (incl. 30% spedizione)", icon:"üñ•Ô∏è" },
  { nome:"P2.5",  cabX:64, cabY:64,  prezzoAgente:675, prezzoCliente:765, prezzoCina:450, info:"Ledwall Display P2.5 | 0.64x0.64 | In/Out | COSTO CINA: 450‚Ç¨ (incl. 30% spedizione)", icon:"üñ•Ô∏è" },
  { nome:"P3",    cabX:57, cabY:57,  prezzoAgente:375, prezzoCliente:425, prezzoCina:250, info:"Ledwall Display P3 | 0.57x0.57 | In/Out | COSTO CINA: 250‚Ç¨", icon:"üñ•Ô∏è" },
  { nome:"P3.91", cabX:50, cabY:100, prezzoAgente:450, prezzoCliente:550, prezzoCina:280, info:"Ledwall Display P3.91 | 0.50x1.00 | In/Out | COSTO CINA: 280‚Ç¨", icon:"üñ•Ô∏è" },
  { nome:"P4",    cabX:96, cabY:96,  prezzoAgente:750, prezzoCliente:850, prezzoCina:580, info:"Ledwall Display P4 | 0.96x0.96 | Outdoor | COSTO CINA: 580‚Ç¨", icon:"üñ•Ô∏è" }
];

// INSTALLAZIONE ‚Äì fasce fino a 20+
const INSTALL_COSTS = [
  { th:1.5,  parete:500,  bandiera:500,  palo:500,  vetrina:400 },
  { th:2.0,  parete:650,  bandiera:600,  palo:600,  vetrina:500 },
  { th:2.75, parete:680,  bandiera:620,  palo:620,  vetrina:520 },
  { th:3.0,  parete:700,  bandiera:680,  palo:680,  vetrina:550 },
  { th:4.0,  parete:850,  bandiera:750,  palo:750,  vetrina:600 },
  { th:5.0,  parete:1000, bandiera:900,  palo:900,  vetrina:700 },
  { th:6.0,  parete:1100, bandiera:1000, palo:1000, vetrina:800 },
  { th:7.0,  parete:1200, bandiera:1100, palo:1100, vetrina:900 },
  { th:8.0,  parete:1300, bandiera:1200, palo:1200, vetrina:1000 },
  { th:9.0,  parete:1400, bandiera:1300, palo:1300, vetrina:1100 },
  { th:15.0, parete:1550, bandiera:1450, palo:1450, vetrina:1200 },
  { th:20.0, parete:1800, bandiera:1650, palo:1650, vetrina:1500 },
  { th:1e9,  parete:2000, bandiera:1950, palo:1950, vetrina:1800 }
];
function installCost(areaMq, tipo){
  if(tipo==='personalizza') return 0;
  let rec = INSTALL_COSTS.find(r => areaMq <= r.th) || INSTALL_COSTS[INSTALL_COSTS.length-1];
  switch(tipo){ case 'parete': return rec.parete; case 'bandiera': return rec.bandiera; case 'palo': return rec.palo; case 'vetrina': return rec.vetrina; default: return 0; }
}

// Provincia ‚Äì km da Catania e costo/km
const PROVINCE_KM = { Catania:0, Siracusa:51, Enna:71, Ragusa:72, Messina:87, Caltanissetta:90, Agrigento:135, Palermo:166, Trapani:231 };
const COSTO_KM = 2.0;

// DOM refs
const baseInput = document.getElementById('base');
const altezzaInput = document.getElementById('altezza');
const bifaccialeInput = document.getElementById('bifacciale');
const installazioneSelect = document.getElementById('installazione');
const provinciaSelect = document.getElementById('provincia');
const provinciaPill = document.getElementById('provinciaPill');
const cardsContainer = document.getElementById('cardsContainer');
const alertContainer = document.getElementById('alertContainer');
const layoutContainer = document.getElementById('layoutContainer');
const whatsappNumber = "393294397445";

let currentPopup = null;

function setProvinciaPill(){
  const km = PROVINCE_KM[provinciaSelect.value] || 0;
  const euro = km * COSTO_KM;
  const maxEuro = PROVINCE_KM['Trapani'] * COSTO_KM;
  const ratio = Math.min(1, euro/maxEuro);
  const hue = 120 - (120*ratio); // verde->rosso
  provinciaPill.style.backgroundColor = `hsl(${hue},85%,45%)`;
  provinciaPill.textContent = `+‚Ç¨ ${Math.round(euro).toLocaleString('it-IT')}`;
  provinciaPill.title = `Sovrapprezzo trasferta (${km} km √ó ‚Ç¨${COSTO_KM.toFixed(2)}/km)`;
}

function animateValue(el,start,end,duration){ let t0=null; const step=(t)=>{ if(!t0)t0=t; const p=Math.min((t-t0)/duration,1); el.textContent=Math.floor(start+(end-start)*p).toLocaleString('it-IT'); if(p<1) requestAnimationFrame(step); }; requestAnimationFrame(step); }

function aggiornaLayout(models, rotatedMatchFlag){
  layoutContainer.innerHTML = "";
  if (Array.isArray(models) && models.length > 1) {
    const p19 = models.find(m=>m.nome==='P1.9'); const p391 = models.find(m=>m.nome==='P3.91');
    if(p19 && p391 && models.length===2){ layoutContainer.innerHTML += `<h3>Layout suggerito per P1.9 / P3.91</h3>`; generaLayout(p19, rotatedMatchFlag); }
    else { models.forEach(m=>{ layoutContainer.innerHTML += `<h3>Layout suggerito per ${m.nome}</h3>`; generaLayout(m, rotatedMatchFlag); }); }
  } else { const m = Array.isArray(models)?models[0]:models; layoutContainer.innerHTML = `<h3>Layout suggerito per ${m.nome}</h3>`; generaLayout(m, rotatedMatchFlag); }
  if(rotatedMatchFlag){ const warn=document.createElement('div'); warn.className='alert'; warn.innerHTML='‚ö†Ô∏è √à possibile ruotare alcuni cabinet rettangolari per ottenere questa misura, ma non √® consigliato.'; layoutContainer.appendChild(warn); }
}

function generaLayout(model, rotatedMatchFlag){
  const bif=bifaccialeInput.checked; const layout=document.createElement('div'); layout.style.display='grid'; layout.style.gridGap='3px'; layout.style.justifyContent='center';
  const isRect = model.cabX===50 && model.cabY===100; const blockW = isRect && rotatedMatchFlag ? 60 : 30; const blockH = isRect && rotatedMatchFlag ? 30 : (isRect ? 60 : 30);
  const base=parseFloat(baseInput.value)||0; const alt=parseFloat(altezzaInput.value)||0;
  let cols = rotatedMatchFlag && isRect ? Math.ceil(base/model.cabY) : Math.ceil(base/model.cabX);
  let rows = rotatedMatchFlag && isRect ? Math.ceil(alt/model.cabX) : Math.ceil(alt/model.cabY);
  layout.style.gridTemplateColumns=`repeat(${cols}, ${blockW}px)`; layout.style.gridTemplateRows=`repeat(${rows}, ${blockH}px)`;
  for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const cell=document.createElement('div'); cell.style.width=`${blockW}px`; cell.style.height=`${blockH}px`; cell.style.borderRadius='4px'; cell.style.margin='1px'; cell.style.backgroundColor=bif?'#ff6f61':'#00aaff'; if(bif) cell.style.border='2px solid red'; layout.appendChild(cell);} }
  layoutContainer.appendChild(layout);
}

function aggiornaCards(){
  const base = parseFloat(baseInput.value); const altezza = parseFloat(altezzaInput.value); const bif=bifaccialeInput.checked; const tipoInst=installazioneSelect.value;
  cardsContainer.innerHTML=''; alertContainer.innerHTML=''; layoutContainer.innerHTML=''; setProvinciaPill();
  if(!base || !altezza) return;

  const kmSelezionati = PROVINCE_KM[provinciaSelect.value] || 0; // <-- km correnti
  const extraKm = kmSelezionati * COSTO_KM;                       // <-- ‚Ç¨ km

  let results = ledwalls.map(model=>{
    const isRect = model.cabX===50 && model.cabY===100;
    let perfect=false, rotated=false;
    if(isRect){ perfect=(base%model.cabX===0 && altezza%model.cabY===0); rotated=(!perfect && (base%model.cabY===0 && altezza%model.cabX===0)); }
    else { perfect=(base%model.cabX===0 && altezza%model.cabY===0); rotated=false; }

    const cols = rotated? Math.ceil(base/model.cabY) : Math.ceil(base/model.cabX);
    const rows = rotated? Math.ceil(altezza/model.cabX) : Math.ceil(altezza/model.cabY);

    let totalCab = cols*rows;
    let prezzoClienteBase = totalCab * model.prezzoCliente; // solo display
    let prezzoAgenteBase  = totalCab * model.prezzoAgente;  // solo display
    let margineCliente    = prezzoClienteBase - (totalCab * model.prezzoCina);
    let margineAgente     = prezzoAgenteBase  - (totalCab * model.prezzoCina);

    if(bif){ totalCab*=2; prezzoClienteBase*=2; prezzoAgenteBase*=2; margineCliente*=2; margineAgente*=2; }

    const displayWidth = cols*(rotated?model.cabY:model.cabX);
    const displayHeight= rows*(rotated?model.cabX:model.cabY);

    const areaMq = (displayWidth/100) * (displayHeight/100);
    const extraInstall = installCost(areaMq, tipoInst); // ‚Ç¨ installazione

    // *** Totali mostrati in card = Display + Installazione + Km
    const prezzoClienteTotale = prezzoClienteBase + extraInstall + extraKm;
    const prezzoAgenteTotale  = prezzoAgenteBase  + extraInstall + extraKm;

    const diffX=Math.abs(base - displayWidth); const diffY=Math.abs(altezza - displayHeight); const diff=diffX+diffY;

    return { ...model,
      colsNeeded:cols, rowsNeeded:rows, totalCab,
      prezzoClienteTotale, prezzoAgenteTotale, // <-- ora includono provincia e installazione
      margineCliente, margineAgente,           // margini solo display (come richiesto)
      margineInstallazione: extraInstall,
      margineKm: extraKm,
      diff, perfectMatch:perfect, rotatedMatch:rotated,
      displayWidth, displayHeight,
      nearestBase: Math.round(base/model.cabX)*model.cabX,
      nearestAltezza: Math.round(altezza/model.cabY)*model.cabY,
      bifacciale:bif,
      prezzoTotale: prezzoClienteTotale        // per ordinamento/tie-break
    };
  });

  const perfectMatches = results.filter(r=>r.perfectMatch);
  const rotatedMatches = results.filter(r=>r.rotatedMatch);
  const bestMatch = results.reduce((p,c)=> c.diff<p.diff?c:p);
  results.sort((a,b)=>{ if(a.perfectMatch&&!b.perfectMatch) return -1; if(!a.perfectMatch&&b.perfectMatch) return 1; return (a.diff+a.prezzoTotale*0.0001)-(b.diff+b.prezzoTotale*0.0001); });
  const bestPriceModel = results.reduce((p,c)=> c.prezzoTotale<p.prezzoTotale?c:p);

  results.forEach(model=>{
    const wrapper=document.createElement('div'); wrapper.style.display='flex'; wrapper.style.flexDirection='column'; wrapper.style.alignItems='center';
    const card=document.createElement('div');
    if(model.perfectMatch) card.className='card green'; else if(model.rotatedMatch) card.className='card yellow'; else card.className='card red';
    if(model.nome===bestPriceModel.nome) card.classList.add('best');

    const popup=document.createElement('div'); popup.className='card-popup'; popup.innerHTML=`<strong>${model.nome}</strong><br>${model.info}`; card.appendChild(popup);

    const whatsappLink=`https://wa.me/${whatsappNumber}?text=${encodeURIComponent((model.perfectMatch||model.rotatedMatch)?`Ti contatto dal calcolatore ADMIN per il modello ${model.nome} con misura ${base} x ${altezza}${model.bifacciale?" (Bifacciale)":""}.`:`Ti contatto dal calcolatore ADMIN per un preventivo personalizzato con modello ${model.nome} e misura ${base} x ${altezza}${model.bifacciale?" (Bifacciale)":""}.`)}`;

    card.innerHTML += `
      <div class="card-icon">${model.icon}</div>
      <h2>${model.nome}</h2>
      <p class="tooltip">Dimensione Cabinet: ${model.cabX} x ${model.cabY} cm
        <span class="tooltiptext">${model.info}</span>
      </p>
      ${(model.perfectMatch||model.rotatedMatch)?`
        <p class="cabinet">Numero Cabinet: <span id="cab${model.nome}">0</span></p>
        <p class="price">Prezzo Agente: <span id="priceAgent${model.nome}">0</span>‚Ç¨</p>
        <p class="priceClient">Prezzo Cliente: <span id="priceClient${model.nome}">0</span>‚Ç¨</p>
        <p class="margin">Margine su Agente: <span id="marginAgent${model.nome}">0</span>‚Ç¨</p>
        <p class="marginClient">Margine su Cliente: <span id="marginClient${model.nome}">0</span>‚Ç¨</p>
        <p class="marginInstall">Margine installazione: <span id="marginInst${model.nome}">0</span>‚Ç¨</p>
        <p class="marginKm">Margine km: <span id="marginKm${model.nome}">0</span>‚Ç¨</p>
        ${model.bifacciale?`<p class="bifacciale-label">BIFACCIALE</p>`:''}
      `:`<p>Misura pi√π vicina: ${model.nearestBase} x ${model.nearestAltezza} cm</p>`}
    `;

    const btn=document.createElement('button'); btn.className='btn-request'; btn.textContent='Richiedi Preventivo'; btn.onclick=()=>window.open(whatsappLink,'_blank');

    card.addEventListener('click',(e)=>{ if(e.target.classList && e.target.classList.contains('btn-request')) return; if(currentPopup && currentPopup!==card){ currentPopup.classList.remove('show-popup'); } card.classList.toggle('show-popup'); currentPopup = card.classList.contains('show-popup') ? card : null; });

    wrapper.appendChild(card); wrapper.appendChild(btn); cardsContainer.appendChild(wrapper);

    if(model.perfectMatch || model.rotatedMatch){ setTimeout(()=>{ card.classList.add('show');
      animateValue(document.getElementById(`cab${model.nome}`),0,model.totalCab,1200);
      animateValue(document.getElementById(`priceAgent${model.nome}`),0,Math.round(model.prezzoAgenteTotale),1200);
      animateValue(document.getElementById(`priceClient${model.nome}`),0,Math.round(model.prezzoClienteTotale),1200);
      animateValue(document.getElementById(`marginAgent${model.nome}`),0,Math.round(model.margineAgente),1200);
      animateValue(document.getElementById(`marginClient${model.nome}`),0,Math.round(model.margineCliente),1200);
      animateValue(document.getElementById(`marginInst${model.nome}`),0,Math.round(model.margineInstallazione),1200);
      animateValue(document.getElementById(`marginKm${model.nome}`),0,Math.round(model.margineKm),1200);
    },50); }
  });

  if(rotatedMatches.length>0){ alertContainer.innerHTML=`<div class="alert">‚ö†Ô∏è √à possibile ruotare alcuni cabinet rettangolari per ottenere questa misura, ma non √® consigliato.</div>`; aggiornaLayout(rotatedMatches,true); }
  else if(perfectMatches.length===0){ alertContainer.innerHTML = `<div class="alert">Per questa misura ti consigliamo un <strong>${bestMatch.nome}</strong> con misure realizzabili ${bestMatch.displayWidth} x ${bestMatch.displayHeight} cm.<br>Puoi richiedere un preventivo personalizzato cliccando <a href="https://wa.me/${whatsappNumber}?text=${encodeURIComponent(`Ti contatto dal calcolatore ADMIN per un preventivo personalizzato con misura ${base} x ${altezza}${(bif? ' (Bifacciale)':'')}.`)}" target="_blank">qui</a>.</div>`; aggiornaLayout([bestMatch],false); }
  else { aggiornaLayout(perfectMatches,false); }
}

baseInput.addEventListener('input', aggiornaCards);
altezzaInput.addEventListener('input', aggiornaCards);
bifaccialeInput.addEventListener('change', aggiornaCards);
installazioneSelect.addEventListener('change', aggiornaCards);
provinciaSelect.addEventListener('change', ()=>{ setProvinciaPill(); aggiornaCards(); });
setProvinciaPill();

// Effetto luce
setInterval(()=>{ const cells=document.querySelectorAll('#layoutContainer > div > div'); cells.forEach((cell,i)=>{ const pulse=Math.sin(Date.now()/400+i)*0.4+0.6; cell.style.filter=`brightness(${pulse})`; }); },80);
</script>
</body>
</html>
